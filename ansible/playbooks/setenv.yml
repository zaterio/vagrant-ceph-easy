---
- hosts: all
  remote_user: vagrant

  vars_files:
   - ../../vars/vars.yml
    
    
  tasks:

   - debug: msg="Running setenv playbook"  
      
   - name: updates a server
     apt: update_cache=yes
     when: not dev
   
   - name: upgrade a server
     apt: upgrade=dist
     when: not dev
   
   - name: instala paquetes
     apt: name="{{ item }}" state=present
     with_items:
      - ntp     
     when: not dev
      
   - name: Allow vagrant to have passwordless sudo
     when: not dev
     lineinfile:
      dest: /etc/sudoers
      state: present
      regexp: '^vagrant'
      line: 'vagrant ALL=(ALL) NOPASSWD: ALL'

      
   - name: Allow {{ cephuser }} to have passwordless sudo
     when: not dev
     lineinfile:
      dest: /etc/sudoers
      state: present
      regexp: '^{{ cephuser }}'
      line: '{{ cephuser }} ALL=(ALL) NOPASSWD: ALL'

      
   - name: crea grupo {{ cephgroup }}
     group: name={{ cephgroup }} state=present
     when: not dev
  
   - name: crea usuario {{ cephuser }}
     user: name={{ cephuser }} group={{ cephgroup }} groups=adm shell=/bin/bash state=present password={{password}}
     when: not dev

   - name: crea dir .ssh
     file:
      path: /home/{{ cephuser }}/.ssh
      owner: "{{ cephuser }}"
      group: "{{ cephgroup }}"
      mode: 0700      
      state: directory

   - name: copia id_rsa.pub {{ cephuser }}
     when: not dev
     copy:
      src: ../templates/ssh/id_rsa.pub
      dest: /home/{{ cephuser }}/.ssh/id_rsa.pub
      owner: "{{ cephuser }}"
      group: "{{ cephgroup }}"
      mode: 0600

   - name: copia id_rsa {{ cephuser }}
     when: not dev
     copy:
      src: ../templates/ssh/id_rsa
      dest: /home/{{ cephuser }}/.ssh/id_rsa
      owner: "{{ cephuser }}"
      group: "{{ cephgroup }}"
      mode: 0600

   - name: copia config ssh
     when: not dev
     template:
      src: ../templates/ssh/config
      dest: /home/{{ cephuser }}/.ssh/config
      owner: "{{ cephuser }}"
      group: "{{ cephgroup }}"
      mode: 0600

   - name: Set authorized key took from file
     when: not dev
     authorized_key:
      user: "{{ cephuser }}"
      state: present
      key: "{{ lookup('file', '../templates/ssh/id_rsa.pub') }}" 

   #- name: Crea directorios OSD
     #file:
      #path: "{{ item.1.mount }}"
      #state: directory
      #owner: "{{ cephuser }}"
      #group: "{{ cephgroup }}"
     #with_subelements: 
       #- "{{cluster| selectattr('node', 'equalto', inventory_hostname )|list}}"
       #- osdnode
       
   #- name: Fomatea discos XFS
     #filesystem: 
      #fstype: xfs
      #dev: "{{ item.1.disk }}"
     #with_subelements: 
       #- "{{cluster| selectattr('node', 'equalto', inventory_hostname )|list}}"
       #-  osdnode
         
   #- name: Monta OSD
     #mount: 
      #name: "{{item.1.mount}}"
      #src: "{{ item.1.disk }}"
      #fstype: xfs
      #state: mounted
     #with_subelements: 
       #- "{{cluster| selectattr('node', 'equalto', inventory_hostname )|list}}"
       #-  osdnode

   #- name: Corrige permisos directorios OSD
     #file: 
      #path: "{{item.1.mount}}"
      #state: directory
      #owner: "{{ cephuser }}"
      #group: "{{ cephgroup }}"
     #with_subelements: 
       #- "{{cluster| selectattr('node', 'equalto', inventory_hostname )|list}}"
       #-  osdnode
